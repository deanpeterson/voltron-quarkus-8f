schemaVersion: 2.2.0
metadata:
  name: java-quarkus
  version: 1.2.1
  provider: Red Hat
  supportUrl: https://github.com/redhat-appstudio/tssc-dev-multi-ci
  icon: https://design.jboss.org/quarkus/logo/final/SVG/quarkus_icon_rgb_default.svg
  website: https://quarkus.io
  displayName: Quarkus Java - Trusted Application Pipeline
  description: Quarkus Java example with advanced continuous integration pipeline
    covering building, CVE scanning, security scanning, signatures, attestations,
    SLSA provenance and SBOM along with Gitops-based continuous deployment.
  tags:
  - Java
  - Quarkus
  - sscs
  - sbom
  - acs
  projectType: Quarkus
  language: Java
  attributes:
    alpha.dockerimage-port: 8081
parent:
  id: java-quarkus
  registryUrl: https://registry.devfile.io
  components:
  - name: tools
    container:
      image: registry.redhat.io/devspaces/udi-rhel9:latest
      memoryLimit: 3Gi
components:
- name: image-build
  image:
    imageName: java-quarkus-image:latest
    dockerfile:
      uri: src/main/docker/Dockerfile.jvm.staged
      buildContext: .
      rootRequired: false
- name: kubernetes-deploy
  attributes:
    deployment/replicas: 1
    deployment/cpuRequest: 10m
    deployment/memoryRequest: 100Mi
    deployment/container-port: 8081
  kubernetes:
    uri: deploy.yaml
    endpoints:
    - name: http-8081
      targetPort: 8081
      path: /
      secure: true
commands:
- id: init-git-config
  exec:
    commandLine: |
      GIT_USER_EMAIL=""
      GIT_USER_NAME=""
      if [ -d /config/user/profile ]; then
        GIT_USER_NAME=$(cat /config/user/profile/name 2>/dev/null || true)
        GIT_USER_EMAIL=$(cat /config/user/profile/email 2>/dev/null || true)
      fi
      if [ -n "$GIT_USER_NAME" ]; then
        git config --global user.name "$GIT_USER_NAME"
      fi
      case "$GIT_USER_EMAIL" in
        *@che|"")
          [ -n "$GIT_USER_NAME" ] && git config --global user.email "${GIT_USER_NAME}@redhat.com"
          ;;
        *)
          git config --global user.email "$GIT_USER_EMAIL"
          ;;
      esac
    component: tools
- id: build-image
  apply:
    component: image-build
- id: deployk8s
  apply:
    component: kubernetes-deploy
- id: deploy
  composite:
    commands:
    - build-image
    - deployk8s
    group:
      kind: deploy
      isDefault: true

events:
  postStart:
    - init-git-config
